# Домашнее задание к занятию «Микросервисы: подходы» Голоха Е.В.

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.



## Решение
1. [Задача 1: Обеспечение разработки (CI/CD)](#dev)
2. [Задача 2: Логи](#logs)
3. [Задача 3: Мониторинг](#monitoring)

---

## <a id="dev">Задача 1: Обеспечение разработки</a>

### Требования
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из Git;
- запуск сборки вручную с параметрами;
- привязка настроек к каждой сборке;
- шаблоны конфигураций сборок;
- безопасное хранение секретов;
- несколько конфигураций сборки из одного репозитория;
- кастомные шаги сборки;
- собственные Docker-образы для сборок;
- собственные агенты сборки;
- параллельные сборки и тесты.

---

### Предлагаемое решение
**GitLab (GitLab SaaS / GitLab Self-Hosted) + GitLab CI/CD + Docker**

---

### Архитектура взаимодействия
- **GitLab Repository** — отдельный репозиторий на каждый микросервис
- **GitLab CI/CD** — управление пайплайнами сборки и доставки
- **Docker Registry** — хранение образов сервисов
- **GitLab Runner** — агенты сборки (cloud + собственные сервера)

---

### Соответствие требованиям

| Требование | Реализация в GitLab |
|---|---|
| Облачная система | GitLab SaaS или Self-Hosted |
| Git VCS | Встроенный Git |
| Репозиторий на сервис | Один репозиторий = один сервис |
| Сборка по событию | Trigger по push / merge request |
| Ручной запуск | Manual jobs с параметрами |
| Настройки сборок | `.gitlab-ci.yml` |
| Шаблоны | CI templates / include |
| Хранение секретов | CI Variables (masked, protected) |
| Несколько конфигураций | Multiple pipelines / rules |
| Кастомные шаги | Любые shell/Docker шаги |
| Собственные Docker-образы | Custom images |
| Собственные агенты | GitLab Runner on-prem |
| Параллельные сборки | Parallel jobs |
| Параллельные тесты | `parallel:` и matrix |

---

### Обоснование выбора
GitLab — это единая платформа, объединяющая Git, CI/CD, registry и управление доступом.  
Подходит для микросервисной архитектуры, так как:
- легко масштабируется;
- полностью автоматизирует путь от кода до продакшена;
- поддерживает GitOps-подход;
- не требует интеграции большого количества внешних инструментов.

---

## <a id="logs">Задача 2: Логи</a>

### Требования
- централизованный сбор логов со всех хостов;
- сбор логов из stdout;
- гарантированная доставка;
- поиск и фильтрация;
- UI-доступ для разработчиков;
- возможность делиться сохранённым поиском.

---

### Предлагаемое решение
**ELK Stack (Elasticsearch + Logstash + Kibana) + Filebeat**

---

### Архитектура взаимодействия
- **Filebeat** — агент на хостах, читает stdout/файлы
- **Logstash** — обработка и маршрутизация логов
- **Elasticsearch** — централизованное хранилище
- **Kibana** — интерфейс поиска и визуализации

---

### Соответствие требованиям

| Требование | Реализация |
|---|---|
| Централизованный сбор | Elasticsearch |
| Минимальные требования | Логи из stdout |
| Гарантированная доставка | Filebeat + persistent queue |
| Поиск и фильтрация | Kibana + DSL |
| UI для разработчиков | Kibana RBAC |
| Ссылки на поиск | Saved Search / URL |

---

### Обоснование выбора
ELK — де-факто стандарт логирования в микросервисах:
- масштабируется горизонтально;
- не требует изменений в коде приложений;
- поддерживает structured logs;
- удобен для Dev и Ops.

---

## <a id="monitoring">Задача 3: Мониторинг</a>

### Требования
- сбор метрик со всех хостов;
- CPU, RAM, HDD, Network;
- метрики по каждому сервису;
- кастомные метрики сервисов;
- UI для запросов и агрегаций;
- UI для дашбордов.

---

### Предлагаемое решение
**Prometheus + Node Exporter + Service Exporters + Grafana**

---

### Архитектура взаимодействия
- **Node Exporter** — метрики хостов
- **Service Exporters** — метрики сервисов (DB, app)
- **Prometheus** — сбор и хранение метрик
- **Grafana** — визуализация и дашборды

---

### Соответствие требованиям

| Требование | Реализация |
|---|---|
| Метрики со всех хостов | Node Exporter |
| CPU/RAM/HDD/Network | Node Exporter |
| Метрики сервисов | Exporters / app metrics |
| Специфичные метрики | Custom metrics |
| Запросы и агрегации | PromQL |
| Дашборды | Grafana |

---

### Обоснование выбора
Prometheus + Grafana:
- стандарт для Kubernetes и микросервисов;
- pull-модель (надёжность);
- мощный язык запросов;
- гибкая визуализация и алерты.

---

## Чек-лист выполнения требований

### Разработка
- [x] Git
- [x] CI/CD
- [x] Secrets
- [x] Параллельность
- [x] Docker
- [x] On-prem агенты

### Логи
- [x] Централизация
- [x] stdout
- [x] Доставка
- [x] Поиск
- [x] UI и шаринг

### Мониторинг
- [x] Хосты
- [x] Сервисы
- [x] Кастомные метрики
- [x] Дашборды

---

## Итог
- **CI/CD:** GitLab CI/CD  
- **Логи:** ELK Stack  
- **Мониторинг:** Prometheus + Grafana  

Решение покрывает все требования микросервисной архитектуры и подходит для промышленной эксплуатации.
